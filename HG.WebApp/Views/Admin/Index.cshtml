@{
    ViewData["Title"] = "Quan ly du lieu";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
    var listUser = ViewBag.ListUser as List<HG.WebApp.AspNetUsers>;
}
@using HG.WebApp.Common;
@using HG.WebApp.Helper
@using X.PagedList
@using X.PagedList.Mvc.Core
@using HG.WebApp.Sercurity;
@model IPagedList<HG.WebApp.Dto.ListtingDTO>
    <!-- jQuery UI 1.11.4 -->
    <script src="https://code.jquery.com/ui/1.11.4/jquery-ui.min.js"></script>
    <script src="~/BackEnd/Admin/Js/Validate/modal.js"></script>
<script>
        $(document).ready(function () {
            $('#fromdate').datepicker({
                autoclose: true
            });
            $('#todate').datepicker({
                autoclose: true
            });
            modalForm.validateForm();
            $("#btnCancel").click(function () {
                $('label[class=error]').hide();
            });
            $("#addTagModal").draggable({
                handle: ".modal-header"
            });
        });
         
           function myFile()
         {
            document.getElementById('file').click();
         };
            $(document).ready(function () {
          $("#file").on('change', function () {            // Checking whether FormData is available in browser
            if (window.FormData !== undefined) {
                var fileUpload = $(this).get(0);
                var files = fileUpload.files;
                // Create FormData object
                var fileData = new FormData();
                // Looping over all files and add it to FormData object
                for (var i = 0; i < files.length; i++) {
                    fileData.append(files[i].name, files[i]);
                }
                // Adding one more key to FormData object
                fileData.append('username', 'Manas');
                $.ajax({
                    url: '/Upload/UploadFilesExcels?folder=Excels',
                    type: "POST",
                    processData: false,
                    contentType: false,
                    data: fileData,
                    success: function (result) {
                        if(result.status == true){
                            window.location.href = "/Admin/index"
                        }
                    },
                    error: function (err) {
                        alert(err.statusText);
                    }
                });
            } else {
                alert("FormData is not supported.");
            }
            });
         });
         function UpdateStatus(abc){
             $.ajax({
                    type: "POST",
                    url: "@Url.Action("Sign","Admin")",
                    data: {Id: abc},
                    dataType: "text",
                    success: function (msg) {
                       alertmsg.success(msg)
                    },
                    error: function (req, status, error) {
                        alertmsg.success("Có lỗi xảy ra!")
                    }
                }); 
         }
</script>
<script>
        function DeleteAllButton(){
            var checkedVals = $('.deleteItem:checkbox:checked').map(function() {
                return this.value;
            }).get();
             //window.location.href = '/Admin/DeleteAll&temps='checkedVals.join(",");
              $.ajax({
                    type: "POST",
                    url: "@Url.Action("DeleteAll")",
                    data: {temps: checkedVals.join(",")},
                    dataType: "text",
                    success: function (msg) {
                       alertmsg.success(msg);
                    },
                    error: function (req, status, error) {
                        alertmsg.error(msg);
                    }
                }); 
        };
        function CheckAllClick(isChecked){
                        if(isChecked) {
		                    $('input[name="language"]').each(function() { 
			                    this.checked = true; 
		                    });
	                    } else {
		                    $('input[name="language"]').each(function() {
			                    this.checked = false;
		                    });
	                    }
        };   
</script>
<div class="container-fluid">
    <div class="card">
    <div class="card-body">
                 @using (Html.BeginForm("Index", "Admin", FormMethod.Get,new { @class = "row" }))
                            {
                              
                                <div class="col-md-2 col-xs-12">
                                        
                                             Tiêu đề: <input name="TieuDe" type="text" id="TieuDe" value="@ViewBag.TieuDe" class="form-control" placeholder="Tiêu đề">
                                 </div>
                                <div class="col-md-2 col-xs-12">
                                    
                                    Tên đầy đủ: <input name="FulName" type="text" id="FulName" value="@ViewBag.FulName" class="form-control" placeholder="Tên đầy đủ">
                               
                                </div>
                                <div class="col-md-2 col-xs-12">
                                            Người đăng:
                                            <select class="form-control" name="UserID" id="UserID">
                                                <option value="-2">-- Không chọn --</option>
                                                @if(listUser != null)
                                                {
                                                    foreach (var item in listUser)
                                                    {
                                                           <option value="@item.Id">@item.UserName</option>
                                                    }
                                                }
                       
                                            </select>
                                           <script>
                                            $("#UserID").val(@ViewBag.UserID);
                                           </script>
                                   
                                </div>
                               <div class="col-md-2 col-xs-12">
                                    Từ ngày:
                                    <div class="input-group date">
                                        <div class="input-group-addon">
                                            <i class="fa fa-calendar"></i>
                                        </div>
                                        <input type="text" name="fromdate" class="form-control pull-right" id="fromdate" value="@(ViewBag.fromdate == null?"":string.Format("{0:MM/dd/yyyy}", (DateTime)ViewBag.fromdate))">
                                    </div>
                             
                               </div>

                                <div class="col-md-2 col-xs-12">
                                
                                    Tới ngày:
                                    <div class="input-group date">
                                        <div class="input-group-addon">
                                            <i class="fa fa-calendar"></i>
                                        </div>
                                        <input type="text" class="form-control pull-right" name="todate" id="todate" value="@(ViewBag.todate == null ? "" : string.Format("{0:MM/dd/yyyy}", (DateTime)ViewBag.todate))">
                                    </div>
                                </div>
                                <div class="col-md-2 col-xs-12">
                                   <div class="input-group" style="margin-top: 20px;">
                                    <button type="submit" class="btn btn-primary">Tìm kiếm</button>
                              
                                </div>
                               
                               </div>
                               
                                
                            }
                            </div>
    </div>
</div>


<div class="card">
    <div class="card-body">
         <div class="box">
                    <div class="box-header">
                        <h3 class="box-title">Danh sách Listting</h3>
                        <a href="/Admin/Add" class="btn btn-primary pull-right">Thêm mới</a>
                        <input type="file" id='file' hidden>
                        <input href="" id="dataExport" onclick="myFile()" class="btn btn-primary pull-right" type="button" value="Import">
                       <input href="/Admin/Add" class="btn btn-primary pull-right" type="button" value="Export"> 
                       <input onclick="DeleteAllButton()" class="btn btn-primary pull-right" type="button" value="Delete All">
                    </div>
                    <!-- /.box-header -->
                    <div class="box-body no-padding">
                        <table class="table table-striped">
                            <tbody>
                                @{int i = 1;}
                                <tr>
                                    <th><input type="checkbox" id="selectall" onclick="CheckAllClick(this.checked)" /></th>
                                    <th>Id/Thẻ</th>
                                    <th>Tiêu đề</th>
                                    <th>Ảnh</th>
                                    <th>Danh mục</th>
                                    <th>Pushlic On</th>
                                    <th>Tên người đại diện</th>
                                    <th>Trạng thái</th>
                                    <th>Người đăng</th>
                                    <th></th>
                                    <th>Xem trước</th>
                                    
                                </tr>
                                @foreach (var item in Model.ToList())
                                {
                                    <tr>
                                          <td style="vertical-align: middle"><input type="checkbox" name="language" class="deleteItem" value="@(item.Id)" /></td>
                                        <td style="vertical-align: middle">
                                            <div class="row">
                                                <div class="col-xs-12">
                                                    <a href="/Admin/Edit/@item.Id">@Html.DisplayFor(modelItem => item.Title)</a>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-xs-12">
                                                    <span style="font-weight: bold;">Mã Listting:</span> @(item.Id)
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-xs-12">
                                                    @{
                                                        var taglist = HelperSql.GetListTags(@item.Id);
                                                        if (taglist.Count > 0)
                                                        {
                                                            foreach (var tag in taglist)
                                                            {
                                                                <a href="/Admin/FindTag?tagName=@(tag.TagName)">#@(tag.TagName)</a><a href="/Admin/DeleteTag/@tag.Id"> x<i class="fa fa-close"></i></a>
                                                            }
                                                        }
                                                    }
                                                    <a href="#" title="Gán tag" id="addTag-@(i-1)" data-toggle="modal" data-target="#addTagModal">
                                                        <i class="fa fa-tag"></i>
                                                    </a>
                                                    <script>
                                                        $('#addTag-@(i-1)').click(function () {
                                                            $('#addTagModal').show();
                                                            $("#listtingId").val(@item.Id);
                                                        });
                                                    </script>
                                                </div>
                                            </div>

                                        </td>
                                        @*<td style="vertical-align: middle">@item.bidv__category.title</td>*@
                                        <td style="vertical-align: middle">@item.Title</td>
                                        <td style="vertical-align: middle">
                                                    <img id="view-card" style="margin-top: 10px;" src="@HelperSql.GetStringIMG(@item.Id)" alt="" width="100" height="100" />
                                        </td>
                                        <td style="vertical-align: middle">
                                    @{
                                        if(item.CategorysString != null)
                                        {
                                            var tempItem = item.CategorysString.Split(";");
                                            for(var j = 0; j< tempItem.Length; j++)
                                                {
                                                    <a href="#" style="color:blue">@tempItem[j].ToString() </a> 
                                                }
                                            }
                                        }
                                       </td>
                                        <td style="vertical-align: middle">@(item.Date != null ? item.Date : "")</td>
                                        <td style="vertical-align: middle">@(item.customerCeo == null ? "": item.customerCeo.FirstName != null ?item.customerCeo.FirstName : "")  </td>
                                        <td style="vertical-align: middle">
                                            <div id="btnStatus_@item.Id">
                                                @if(ViewBag.CanSign == "True"){
                                                    @Html.Raw( (item.Status == 0 ? "<span style='color:#2b6893;cursor: pointer;' onclick='UpdateStatus(" + @item.Id + ")'>Chưa duyệt</span>" : "<span style='color:red;cursor: pointer;' onclick='UpdateStatus(" + @item.Id + ")'>Đã Duyệt</span>") ) 
                                                } else{@Html.Raw("<span> Chỉ dành cho admin </span>")}
                                            </div>
                                        </td>
                                        <td style="vertical-align: middle">@HG.WebApp.Helper.HelperSql.GetUserName(@item.UserID) </td>
                                        <td style="vertical-align: middle">
                                            <a href="/Admin/Edit/@item.Id" class="btn btn-warning btn-bordered" title="sửa">
                                                <i class="glyphicon glyphicon-pencil"></i>
                                            </a>
                                            <a onclick="confirm.BeforDelete('/Admin/DeleteListting/@item.Id')" class="btn btn-danger btn-bordered" title="xóa">
                                                <i class="glyphicon glyphicon-trash"></i>
                                            </a>
                                        </td>
                                        <td style="vertical-align: middle"><button data-toggle="modal" data-target="#dpmhModal" id="myBtn" onclick="getObjDuAn(@item.Id)">xem trước</button></td>
                                        
                                        </tr>
                                    i++;
                                }
                            </tbody>
                        </table>
                       
                    </div>
                     <div class="container">
                            @if (Model.PageCount > 1)
                            {
                                @Html.PagedListPager(Model, page => Url.Action("Index", new { page, TieuDe = ViewBag.TieuDe, FulName = ViewBag.FulName, UserID = ViewBag.UserID, fromdate = ViewBag.fromdate, todate = ViewBag.todate }),
                                 new  X.PagedList.Web.Common.PagedListRenderOptions{
                                       LiElementClasses = new string[] { "page-item" },
                                       PageClasses = new string[] { "page-link" }
                                })
                            }
                        </div>
                    <!-- /.box-body -->
                </div>
    </div>
<div class="modal" role="dialog" id="addTagModal" style="background:transparent !important;">
    <div class="modal-dialog">
        <div class="modal-content">
            @using (Html.BeginForm("AddTagName", "Admin", FormMethod.Post, new { enctype = "multipart/form-data", id = "addTagModalForm" }))
            {
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">x</span>
                    </button>
                    <h4 class="modal-title">Thêm tag</h4>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-xs-3">
                            <input type="hidden" id="listtingId" name="listtingId" />
                            <label>Từ khóa</label>
                        </div>
                        <div class="col-xs-9">
                            <input type="text" name="tagName" id="tagName" class="form-control" />
                        </div>
                    </div>

                </div>
                <div class="modal-footer">
                    <div class="row">
                        <div class="col-sm-12">
                            <button id="btnAccept" class="btn btn-primary">Đồng ý</button>
                            <button id="btnCancel" class="btn btn-default pull-right" data-dismiss="modal">Hủy bỏ</button>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<div class="c"></div>
<div class="modal fade" id="dpmhModal" role="dialog">
    <div class="modal-dialog">
        <!-- Modal content-->
        <div class="modal-content" style="width:978px">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title" style="text-align:center;color:red">Xem trước bài đăng</h4>
            </div>
            <div class="c"></div>
            <div class="body">
                <div id="DetailFaq">

                </div>
            </div>
            <div class="c"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>

    </div>
</div>
</div>
 <script>
    function getObjDuAn(id) {
        $.get("/AdminNews/viewDemo?id=" + id, function (res) {
            $("#DetailFaq").html(res);
        });
    }
</script>

<style>
    .table tbody tr td {
        vertical-align: middle;
    }
</style>